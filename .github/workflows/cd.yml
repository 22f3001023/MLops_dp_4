# Name of your workflow
name: Continuous Deployment ðŸš€

# This workflow runs on every push to the 'main' branch
on:
  push:
    branches:
      - "main" # Or "master", whatever your default branch is

# Environment variables available to all jobs
env:
  # Your GCP Project ID
  GCP_PROJECT_ID: linear-stock-473507-v3
  
  # The GKE cluster name you created
  GKE_CLUSTER: autopilot-cluster-1
  
  # The GKE cluster zone/region
  GKE_ZONE: us-central1
  
  # The Artifact Registry repo you created
  GAR_REPO: iris-api
  
  # The name for your Docker image
  IMAGE_NAME: iris-app
  
  # The path to your Kubernetes deployment file
  DEPLOYMENT_FILE: ".k8s/deployment.yml"

jobs:
  build-and-push:
    name: Build and Push to GAR
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    # This 'outputs' section is necessary to pass the URL to the next job
    outputs:
      IMAGE_URL: ${{ steps.set-output.outputs.IMAGE_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to GCP
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.GKE_ZONE }}-docker.pkg.dev

    - name: Define Image Tag
      id: tag
      run: |
        echo "IMAGE_TAG=${{ env.GKE_ZONE }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build Docker Image
      run: |
        docker build \
          --tag ${{ steps.tag.outputs.IMAGE_TAG }} \
          .

    - name: Push Docker Image
      run: docker push ${{ steps.tag.outputs.IMAGE_TAG }}

    - name: Set Image Tag Output
      id: set-output
      run: echo "IMAGE_URL=${{ steps.tag.outputs.IMAGE_TAG }}" >> $GITHUB_OUTPUT

  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push # Ensures this job waits for the build
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to GCP
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
        
    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: Get GKE credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}

    # ðŸ›‘ Use this dedicated action for replacement. It's more reliable than sed.
    - name: Replace Image URL Placeholder ðŸ”„
      uses: c-hive/gha-token-replace@v1
      with:
        files: ${{ env.DEPLOYMENT_FILE }} 
        from: __IMAGE_URL__
        to: ${{ needs.build-and-push.outputs.IMAGE_URL }} # Gets the output from the 'build-and-push' job
        
    # Debug step to confirm the replacement worked
    - name: Debug - Show Final Deployment YAML ðŸ”Ž
      run: |
        echo "--- Manifest after replacement ---"
        cat ${{ env.DEPLOYMENT_FILE }}
        echo "----------------------------------"

    - name: Deploy to GKE
      run: |
        kubectl apply -f ${{ env.DEPLOYMENT_FILE }}
