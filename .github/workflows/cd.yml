# Name of your workflow
name: Continuous Deployment ðŸš€

# This workflow runs on every push to the 'main' branch
on:
  push:
    branches:
      - "main" # Or "master", whatever your default branch is

# Environment variables available to all jobs (using your project details)
env:
  # Your GCP Project ID (set via secret)
  GCP_PROJECT_ID: linear-stock-473507-v3
  
  # The GKE cluster name you created
  GKE_CLUSTER: autopilot-cluster-1
  
  # The GKE cluster zone/region (NOTE: Autopilot clusters use REGION, so us-central1 is correct)
  GKE_ZONE: us-central1
  
  # The Artifact Registry repo you created
  GAR_REPO: iris-api
  
  # The name for your Docker image
  IMAGE_NAME: iris-app
  
  # The path to your Kubernetes deployment file
  DEPLOYMENT_FILE: ".k8s/deployment.yml"

jobs:
  build-and-push:
    name: Build and Push to GAR
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write' # Required for GCP authentication

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Authentication Block ---
    - name: Authenticate to GCP
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.GKE_ZONE }}-docker.pkg.dev
    # -----------------------------

    # --- Build and Push Block ---
    - name: Define Image Tag
      id: tag
      run: |
        echo "IMAGE_TAG=${{ env.GKE_ZONE }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build Docker Image
      run: |
        docker build \
          --tag ${{ steps.tag.outputs.IMAGE_TAG }} \
          .

    - name: Push Docker Image
      run: docker push ${{ steps.tag.outputs.IMAGE_TAG }}

    - name: Set Image Tag Output
      id: set-output
      run: echo "IMAGE_URL=${{ steps.tag.outputs.IMAGE_TAG }}" >> $GITHUB_OUTPUT
    # -----------------------------

  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push 
    
    permissions:
      contents: 'read'
      id-token: 'write' # Required for GCP authentication

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Authentication Block ---
    - name: Authenticate to GCP
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
        
    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'
    # -----------------------------

    # --- Deployment Setup ---
    - name: Get GKE credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}

    # 1. Capture the URL and perform the robust substitution
    - name: Update Kubernetes Manifest with Image Tag âœ…
      run: |
        # Set image URL as a shell variable
        IMAGE_URL="${{ needs.build-and-push.outputs.IMAGE_URL }}"
        DEPLOYMENT_FILE="${{ env.DEPLOYMENT_FILE }}"
        
        # Use sed with the '|' delimiter (common for file paths)
        # We wrap the command in double quotes to ensure the shell variable is expanded.
        sed -i "s|__IMAGE_URL__|$IMAGE_URL|g" $DEPLOYMENT_FILE

    # 2. Debug: Show the deployment file content to confirm replacement
    - name: Debug - Show Final Deployment YAML ðŸ”Ž
      run: |
        echo "--- Manifest after replacement ---"
        # Print the contents of the Deployment file
        cat ${{ env.DEPLOYMENT_FILE }}
        echo "----------------------------------"

    # 3. Deploy the application to GKE
    - name: Deploy to GKE
      run: |
        kubectl apply -f ${{ env.DEPLOYMENT_FILE }}
